//
//  StoreViewController.m
//  BenchtopDemo
//
//  Created by Jeff Tan-Ang on 29/11/12.
//  Copyright (c) 2012 Cook App Pty Ltd. All rights reserved.
//

#import "StoreViewController.h"
#import "FriendsStoreCollectionViewController.h"
#import "FeaturedStoreCollectionViewController.h"
#import "StoreBookCoverViewCell.h"
#import "LoginViewController.h"

@interface StoreViewController () <LoginViewControllerDelegate>

@property (nonatomic, strong) UIView *backgroundView;
@property (nonatomic, strong) FeaturedStoreCollectionViewController *featuredViewController;
@property (nonatomic, strong) FriendsStoreCollectionViewController *friendsViewController;
@property (nonatomic, strong) LoginViewController *loginViewController;
@property (nonatomic, strong) UIImageView *featuredBanner;
@property (nonatomic, strong) UIImageView *friendsBanner;

@end

@implementation StoreViewController

#define kInsets                 UIEdgeInsetsMake(100.0, 0.0, 100.0, 0.0)
#define kStoreShadowOffset      31.0

- (void)viewDidLoad {
    [super viewDidLoad];
    
    self.view.autoresizingMask = UIViewAutoresizingFlexibleRightMargin|UIViewAutoresizingFlexibleWidth;
    [self initBackground];
}

- (void)viewDidAppear:(BOOL)animated {
    [super viewDidAppear:animated];
    
    CGFloat rowHeight = [StoreBookCoverViewCell cellSize].height;
    
    FeaturedStoreCollectionViewController *featuredViewController = [[FeaturedStoreCollectionViewController alloc] init];
    featuredViewController.view.frame = CGRectMake(self.view.bounds.origin.x,
                                                   self.view.bounds.size.height - rowHeight - 280.0,
                                                   self.view.bounds.size.width,
                                                   rowHeight);
    featuredViewController.view.autoresizingMask = UIViewAutoresizingFlexibleRightMargin|UIViewAutoresizingFlexibleWidth|UIViewAutoresizingFlexibleTopMargin;
    [self.view addSubview:featuredViewController.view];
    self.featuredViewController = featuredViewController;
    [featuredViewController loadData];
    
    FriendsStoreCollectionViewController *friendsViewController = [[FriendsStoreCollectionViewController alloc] init];
    friendsViewController.view.frame = CGRectMake(self.view.bounds.origin.x,
                                                  self.view.bounds.size.height - rowHeight + 48.0,
                                                  self.view.bounds.size.width,
                                                  rowHeight);
    friendsViewController.view.autoresizingMask = UIViewAutoresizingFlexibleRightMargin|UIViewAutoresizingFlexibleWidth|UIViewAutoresizingFlexibleBottomMargin;
    [self.view addSubview:friendsViewController.view];
    self.friendsViewController = friendsViewController;
    [friendsViewController loadData];
    
    [self initBanners];
    [self initLoginViewIfRequired];
}

- (void)enable:(BOOL)enable {
    [self.featuredViewController enable:enable];
    [self.friendsViewController enable:enable];
    [self showBanners:enable animated:enable];
}

#pragma mark - LoginViewControllerDelegate methods

- (void)loginViewControllerSuccessful:(BOOL)success {
    if (success) {
        [self.loginViewController.view removeFromSuperview];
        self.loginViewController = nil;
    }
}

#pragma mark - Private methods

- (void)initBackground {
    UIImageView *backgroundView = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"cook_dash_bg_shelves.png"]];
    self.view.frame = CGRectMake(self.view.frame.origin.x,
                                 self.view.frame.origin.y,
                                 backgroundView.frame.size.width,
                                 backgroundView.frame.size.height);
    [self.view addSubview:backgroundView];
    [self.view sendSubviewToBack:backgroundView];
    self.backgroundView = backgroundView;
}

- (void)initBanners {
    UIImageView *featuredBanner = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"cook_dash_library_banner_featured.png"]];
    UIView *featuredContainer = [[UIView alloc] initWithFrame:CGRectMake(0.0,
                                                                         self.view.bounds.size.height - 692.0,
                                                                         featuredBanner.frame.size.width,
                                                                         featuredBanner.frame.size.height)];
    featuredContainer.clipsToBounds = YES;
    [featuredContainer addSubview:featuredBanner];
    [self.view addSubview:featuredContainer];
    self.featuredBanner = featuredBanner;

    UIImageView *friendsBanner = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"cook_dash_library_banner_friends.png"]];
    UIView *friendsContainer = [[UIView alloc] initWithFrame:CGRectMake(0.0,
                                                                        self.view.bounds.size.height - 360.0,
                                                                        friendsBanner.frame.size.width,
                                                                        friendsBanner.frame.size.height)];
    friendsContainer.clipsToBounds = YES;
    [friendsContainer addSubview:friendsBanner];
    [self.view addSubview:friendsContainer];
    self.friendsBanner = friendsBanner;
    
    [self showBanners:NO animated:NO];
}

- (void)initLoginViewIfRequired {
    CKUser *currentUser = [CKUser currentUser];
    if (![currentUser isSignedIn]) {
        
        LoginViewController *loginViewController = [[LoginViewController alloc] initWithDelegate:self];
        loginViewController.view.frame = CGRectMake(self.view.bounds.origin.x,
                                                    self.view.bounds.size.height - loginViewController.view.frame.size.height - kStoreShadowOffset,
                                                    loginViewController.view.frame.size.width,
                                                    loginViewController.view.frame.size.height);
        [self.view addSubview:loginViewController.view];
        self.loginViewController = loginViewController;
    }
}

- (void)showBanners:(BOOL)show animated:(BOOL)animated {
    
    CGAffineTransform featuredTransform = CGAffineTransformMakeTranslation(0.0, -self.featuredBanner.frame.size.height);
    CGAffineTransform friendsTransform = CGAffineTransformMakeTranslation(0.0, -self.friendsBanner.frame.size.height);
    if (animated) {
        [UIView animateWithDuration:0.2
                              delay:0.0
                            options:UIViewAnimationCurveEaseIn
                         animations:^{
                             self.featuredBanner.transform = show ? CGAffineTransformIdentity : featuredTransform;
                             self.friendsBanner.transform = show ? CGAffineTransformIdentity : friendsTransform;
                         }
                         completion:^(BOOL finished) {
                         }];
    } else {
        self.featuredBanner.transform = show ? CGAffineTransformIdentity : featuredTransform;
        self.friendsBanner.transform = show ? CGAffineTransformIdentity : friendsTransform;
    }
}

@end
